---
title: "MA figures"
author: "Carrie Hamilton"
output:
  html_document: 
    fig_height: 3.5
    df_print: paged
    toc: TRUE
    toc_float: TRUE
    mathjax: NULL
    self_contained: FALSE
css: "styles.css"
font_family: Garamond, "EB Garamond", Georgia, serif;
mainfont: Garamond, "EB Garamond", Georgia, serif;
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, cache=FALSE, out.width="100%")
options(scipen = 999)

options(repos = list(CRAN="http://cran.rstudio.com/"))
install.packages("pacman")
library(pacman)

p_load(bookdown,
       rmarkdown,
       data.table,
       reticulate,
       dplyr, 
       DT,
       ggrepel,
       chromote,
       webshot2,
       htmlwidgets,
       htmltools,
       lubridate,
       plotly,
       stopwords,
       tictoc,
       tidyverse, 
       stringi,
       readxl,
       writexl,
       pals,
       orca)

```

```{r variable set-up, include=FALSE}

##### ORIGINAL: 200 TOPICS, 1-3 WORD REPRESENTATION
size <- "ChunksSubset_OR_100-200"
min_chunk_size <- 100
max_chunk_size <- 200
enviro <- "enviro_v2"
labor <- "labor_v1"
version <- paste(enviro,labor,sep="_")
n_neighbors <- 5
n_min <- 1
n_max <- 3
min_cluster_size <- 200
iteration <- "_outlierReduction"
topicsRemove <- c(-1,8,24,39,77,83,88)

##### ORIGINAL: 200 TOPICS, 2-3 WORD REPRESENTATION
# size <- "ChunksSubset_OR_100-200"
# min_chunk_size <- 100
# max_chunk_size <- 200
# enviro <- "enviro_v2"
# labor <- "labor_v1"
# version <- paste(enviro,labor,sep="_")
# n_neighbors <- 5
# n_min <- 2
# n_max <- 3
# min_cluster_size <- 200
# iteration <- "_outlierReduction"
# topicsRemove <- c(-1,8,24,39,50,77,83,88)

##### MERGE: 200 TOPICS, 1-3 WORD REPRESENTATION
# size <- "ChunksSubset_OR_100-200"
# min_chunk_size <- 100
# max_chunk_size <- 200
# enviro <- "enviro_v2"
# labor <- "labor_v1"
# version <- paste(enviro,labor,sep="_")
# n_neighbors <- 5
# n_min <- 1
# n_max <- 3
# min_cluster_size <- 200
# iteration <- "_outlierReduction_MERGE"
# # topicsRemove <- c(-1,2,26,33,42,45,52,53,54) #outliers, committees, education, children, aircraft, federal shutdown, sugar, pandemic, puerto rico
# topicsRemove <- c(-1,2,42,45,50,51,52,53)

##### MERGE: 200 TOPICS, 2-3 WORD REPRESENTATION
# size <- "ChunksSubset_OR_100-200"
# min_chunk_size <- 100
# max_chunk_size <- 200
# enviro <- "enviro_v2"
# labor <- "labor_v1"
# version <- paste(enviro,labor,sep="_")
# n_neighbors <- 5
# n_min <- 2
# n_max <- 3
# min_cluster_size <- 200
# iteration <- "_outlierReduction_MERGE"
# topicsRemove <- c(-1,2,13,49,50,53) #outliers, committees, education, children, aircraft, federal shutdown, sugar, pandemic, puerto rico

##### ORIGINAL: 500 TOPICS, 1-3 WORD REPRESENTATION
# size <- "Chunks_50-100"
# min_chunk_size <- 50
# max_chunk_size <- 100
# enviro <- "enviro_v2"
# labor <- "labor_v1"
# version <- paste(enviro,labor,sep="_")
# n_neighbors <- 5
# n_min <- 1
# n_max <- 3
# min_cluster_size <- 500
# # iteration <- ""
# iteration <- "_outlierReduction"
# topicsRemove <- c(-1,6,15,25,60,73,75,79,96,100,101,106,107)

##### ORIGINAL: 500 TOPICS, 2-3 WORD REPRESENTATION
# size <- "Chunks_50-100"
# min_chunk_size <- 50
# max_chunk_size <- 100
# enviro <- "enviro_v2"
# labor <- "labor_v1"
# version <- paste(enviro,labor,sep="_")
# n_neighbors <- 5
# n_min <- 2
# n_max <- 3
# min_cluster_size <- 500
# # iteration <- ""
# iteration <- "_outlierReduction"
# topicsRemove <- c(-1,6,15,25,60,73,75,79,96,100,101,106,107)

######################################################################
######################################################################
######################################################################

##### MODEL
model_name <- paste("enviroLabor",size,"_",version,"_n",n_min,"-",n_max,"_umap",n_neighbors,"_c",min_cluster_size,iteration,sep="") #nr_topics,
file_name = paste("enviroLabor",size,"_",version,"_c",min_cluster_size,iteration,sep="")

```

```{r MODEL VERSION, results="asis", echo=FALSE}

# cat(paste0("\n### ",model_name,"\n"))
cat(paste0("## MODEL VERSION","\n"))

cat(paste0("<center><b>enviro dictionary:</b> ",enviro,"\\n"))
cat(paste0("<center><b>labor dictionary:</b> ",labor,"\\n"))
cat(paste0("<center><b>min topic size:</b> ",min_cluster_size," chunks","\\n"))
cat(paste0("<center><b>chunk size:</b> ",min_chunk_size,"-",max_chunk_size," words","\\n"))
cat(paste0("<center><b>periods:</b> 2-year","\\n"))

```

```{r input data, include=FALSE, eval=FALSE}

#### LOAD DATA
load(verbose=TRUE,paste("data/enviroSpeeches_",enviro,".Rda",sep=""))
load(verbose=TRUE,paste("data/laborSpeeches_",labor,".Rda",sep=""))

#### PROCESSING
enviroLaborSpeeches <- laborSpeeches %>% #_subset
  inner_join(select(enviroSpeeches,speech_id,date,environment),join_by(speech_id,date)) %>% #_subset
  # select(speech_id:environment,labor,word_count:last_col()) %>%
  filter(year>=1885) %>%
  # filter(chamber!="E") %>%
  # filter(year>=1965) %>%
  mutate(word_count = str_count(speech, '\\w+')) %>%
  # mutate(word_count = map(speech, \(speech) stri_stats_latex(speech)[4]),
  #        word_count = as.numeric(str_extract(word_count,"[:digit:]+"))) %>%
  mutate(#period20yr = as.numeric(year) - (as.numeric(year)-5) %% 20,
         #period10yr = as.numeric(year) - (as.numeric(year)-5) %% 10,
         #period4yr = as.numeric(year) - (as.numeric(year)-1) %% 4,
         period2yr = as.numeric(year) - (as.numeric(year)-1) %% 2,
         # period2yr = as.numeric(year) - 1 + as.numeric(year) %% 2,
         period1yr = as.numeric(year))

# enviroLaborSpeeches_totals <- enviroLaborSpeeches %>%
#   select(period1yr,total_annual_speeches) %>%
#   distinct() %>%
#   rename("Year"="period1yr",
#          "Total_Annual_Speeches"="total_annual_speeches")
# save(enviroLaborSpeeches_totals,file=paste("topic_models/enviroLabor/",size,"/",model_name,"/enviroLaborSpeeches_totals.Rda",sep=""))
# 
# 
# enviroLaborSpeeches_totals_2yr <- enviroLaborSpeeches %>%
#   select(year,period2yr,total_annual_speeches) %>%
#   distinct() %>%
#   group_by(period2yr) %>%
#   summarize(Total_Annual_Speeches=sum(total_annual_speeches)) %>%
#   rename("Year"="period2yr")
# save(enviroLaborSpeeches_totals_2yr,file=paste("topic_models/enviroLabor/",size,"/",model_name,"/enviroLaborSpeeches_totals_2yr.Rda",sep=""))

```

```{r load topics + dtm, include=FALSE}

# load(file=paste("data/full_speech_totals_2yr.Rda",sep=""))

topic_info <- read_excel(paste("topic_models/enviroLabor/",size,"/",model_name,"/",file_name,".xlsx",sep=""),
                       sheet = "topic_info") %>%
  filter(!(Topic %in% topicsRemove))
DT::datatable(topic_info)

dtm_2yr <- read_excel(paste("topic_models/enviroLabor/",size,"/",model_name,"/",file_name,".xlsx",sep=""), 
                      sheet = "dtm_2yr") %>%
  filter(!(Topic %in% topicsRemove)) 
  # left_join(enviroLaborSpeeches_totals_2yr) %>%
  # # mutate(Words=str_split(Words,", ")) %>%
  # mutate(Proportion_Total=Frequency/Total_Annual_Speeches,
  #        Name_trunc=str_trunc(Name,15))

dtm_4yr <- read_excel(paste("topic_models/enviroLabor/",size,"/",model_name,"/",file_name,".xlsx",sep=""), 
                      sheet = "dtm_4yr") %>%
  filter(!(Topic %in% topicsRemove)) 


docs <- read_csv(paste("topic_models/enviroLabor/",size,"/",model_name,"/","topic_docs_",file_name,".csv",sep="")) %>%
  filter(!(Topic %in% topicsRemove)) %>%
  select(speech_id,period2yr,Topic,Name) %>%
  rename("Year"="period2yr") %>%
  mutate(contains_topic=1) %>%
  distinct() %>%
  arrange(Topic) %>%
  mutate (Name_trunc=str_trunc(Name,15))
docs <- docs %>%
  mutate(Name=factor(Name,levels = unique(Name))) %>%
  mutate(Name_trunc=factor(Name_trunc,levels = unique(Name_trunc)))


```

## ALL TOPICS

```{r prop total dtm, out.width="100%"}

#fig.asp=0.5, out.width='100%'

# plot_dtm_1yr <- readRDS(file=paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_1yr_proportions.rds",sep=""))

periods=c("2yr") #c("20yr","10yr","4yr","1yr") # "6month" 

for (period in periods) {

  eval(parse(text=paste("dtm <- dtm_",period,sep="")))
  
  dtm <- dtm %>% 
    mutate(Name_trunc=factor(Name_trunc,levels = unique(dtm$Name_trunc)))

  dtm_plot <- ggplot() +
    geom_line(data= dtm,
              lwd=0.5,
              aes(x=Year,
                  y=Proportion_Total_Speeches,
                  group=1,
                  color=Name_trunc,
                  # text=paste(Year))) +
                  text=paste("<b>YEAR: </b>",Year,
                             "   <b>TOPIC: </b>",Name,
                             "<br><b>COUNT: </b>",Frequency_Speeches,
                             "    <b>PERIOD SPEECHES: </b>",round(Proportion_Total_Speeches*100,2),"%",
                             "<br>",str_trunc(Words,100),sep=""))) +
                  # text=paste("<b>[",Year,"] TOPIC ",Topic,": </b>",str_trunc(Hover,50)))) +
    geom_point(data=dtm,
               size=1,
               aes(x=Year,
                   y=Proportion_Total_Speeches,
                   group=1,
                   color=Name_trunc,
                  text=paste("<b>YEAR: </b>",Year,
                             "   <b>TOPIC: </b>",Name,
                             "<br><b>COUNT: </b>",Frequency_Speeches,
                             "    <b>PERIOD SPEECHES: </b>",round(Proportion_Total_Speeches*100,2),"%",
                             "<br>",str_trunc(Words,100),sep=""))) +
    scale_colour_manual(values=c(
      unname(alphabet()),
      unname(alphabet2()),
      unname(polychrome()),
      unname(glasbey()),
      unname(cols25()),
      unname(alphabet()),
      unname(alphabet2()),
      unname(polychrome()),
      unname(glasbey()))) +
    # ggtitle(paste(period," topics over time",sep="")) +
    guides(color=guide_legend(title = "<b>TOPIC:</b>")) +
    # scale_x_continuous(breaks = seq(1880, 2020, by = 10)) + 
    theme_minimal() +
  theme(
    legend.title=element_text(family="EB Garamond", size=10,face="bold"), #color="#32127a",
    legend.text=element_text(family="EB Garamond", size=8),  #color="#32127a",
    plot.title=element_text(family="EB Garamond",hjust=0.5,size=18,face="bold"),  #color="#32127a",
    axis.title.x=element_blank(),
    axis.title.y=element_text(family="EB Garamond", size=16),  #color="#32127a",
    axis.text=element_text(family="EB Garamond",size=14),#,size=10),  #color="#32127a",
    # axis.line=element_line(color="#32127a"),  
    # axis.ticks=element_line(color="#32127a"),  
    strip.text=element_text(family="EB Garamond",face="bold"),
    panel.grid.major.x = element_line(),
    panel.grid.major.y = element_line(),
    panel.grid.minor.x = element_line(),
    panel.grid.minor.y = element_line())
  
  ##### make interactive
  ggplotly(dtm_plot, tooltip="text", dynamicTicks=T) %>% #height=350 #height=400, width=1100
    style(
          visible="legendonly",
          # mode = "markers+lines",
          hoverlabel=list(align="end",
                          #xanchor="left",
                          font=list(family="EB Garamond",
                                    size=11))) %>%
    # rangeslider() %>%
    layout(
      autosize = TRUE,
      # margin = list(t = 50, r = 10, b = 200, l = 50),
      # hovermode="x",
      font=list(family="EB Garamond"), ##32127a
      legend=list(#margin = list(t = 200, r = 10, b = 200, l = 200),
                  #x=0.65,xanchor='center', xref="container", #xref="paper"
                  #y=-0.2,yanchor='top', yref="container", #xref="paper"
                  orientation='v')) %>%
                  # traceorder="reversed",
                  # title=list(font=list(family="IBM Plex Mono")),
                  # font=list(family="IBM Plex Mono", size=11))) %>%
    partial_bundle() %>%
    # saveWidget(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_",period,"_",file_name,".html",sep=""),selfcontained = F, libdir = "lib")
    saveRDS(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_",period,"_proportions_total.rds",sep=""))
}

# plot_dtm_1yr <- readRDS(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_1yr_proportions_total.rds",sep=""))
# plot_dtm_1yr %>%
#   style(visible=TRUE)

```

```{r viz prop total dtm, out.width="100%", fig.height=325, out.height=325}

# plot_dtm_4yr_proportions_total<- readRDS(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_4yr_proportions_total.rds",sep="")) %>%
#   layout(autosize=TRUE,
#          font=list(family="EB Garamond"),
#          legend=list(font=list(family="EB Garamond",size=10),
#                      orientation='v',
#                      # xanchor="center",
#                      # x=0.5,
#                      # y=-0.1,
#                      # yanchor='top',
#                      # yref="paper",
#                      title=FALSE),
#          title=list(font=list(family="EB Garamond",size=14,face="bold")),
#          xaxis = list(title=list(font=list(family="EB Garamond",size=12)),
#                       tickfont=list(family="EB Garamond",size=10)),
#          yaxis = list(title=list(font=list(family="EB Garamond",size=12)),
#                       tickfont=list(family="EB Garamond",size=10))) %>%
#   partial_bundle()
# 
# plot_dtm_4yr_proportions_total %>%
#   style(visible=TRUE)

plot_dtm_2yr_proportions_total<- readRDS(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_2yr_proportions_total.rds",sep="")) %>%
  layout(autosize=TRUE,
         font=list(family="EB Garamond"),
         legend=list(font=list(family="EB Garamond",size=10),
                     orientation='v',
                     # xanchor="center",
                     # x=0.5,
                     # y=-0.1,
                     # yanchor='top',
                     # yref="paper",
                     title=FALSE),
         title=list(font=list(family="EB Garamond",size=14,face="bold")),
         xaxis = list(title=list(font=list(family="EB Garamond",size=12)),
                      tickfont=list(family="EB Garamond",size=10)),
         yaxis = list(title=list(font=list(family="EB Garamond",size=12)),
                      tickfont=list(family="EB Garamond",size=10))) %>%
  partial_bundle()

plot_dtm_2yr_proportions_total %>%
  style(visible=TRUE)

```


## BY TOPIC

```{r vis 2-YEAR html plots, eval=FALSE}

TOPICS <- pull(topic_info,Topic)
trace <- 0

# for (trace in TRACES) {
for (topic in TOPICS) {
  
  trace <- trace+1
  
  name <- toupper(str_extract(topic_info$Name[topic_info$Topic==topic],pattern="_[[:alpha:][:blank:]]+_[[:alpha:][:blank:]]+_"))
  
  # plot_dtm_2yr_proportions_total %>%
  #   style(showlegend=FALSE) %>%
  #   style(traces=c(trace,trace+nrow(topic_info)),visible="True") %>%
  #   layout(font=list(family="EB Garamond"),
  #          xaxis = list(range=list(1885,2024),autorange=FALSE,
  #                       title=list(font=list(family="EB Garamond",size=12)),
  #                       tickfont=list(family="EB Garamond",size=10)),
  #          yaxis = list(title=list(font=list(family="EB Garamond",size=12)),
  #                       tickfont=list(family="EB Garamond",size=10))) %>%
  #   plotly_build() %>%
  #   partial_bundle() %>%
  #   saveWidget(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_2yr_proportions_total_topic_",topic,".html",sep=""),selfcontained = FALSE,libdir="lib")

  
  topic_docs_id <- docs %>%
    filter(Topic==topic) %>%
    pull(speech_id)
  topic_docs <- docs %>%
    filter(speech_id %in% topic_docs_id) %>%
    filter(Topic!=topic) %>%
    left_join(select(dtm_2yr,Year,Topic,Frequency_Speeches,Words)) %>%
    rename("Frequency_Topic_Speeches"="Frequency_Speeches") %>%
    mutate(Topic=topic) %>%
    left_join(select(dtm_2yr,Year,Topic,Frequency_Speeches)) %>%
    # mutate(primary_topic=1) %>%
    # group_by(Year) %>%
    # mutate(primary_topic=n_distinct(speech_id)) %>%
    # ungroup() %>%
    group_by(Year,Name_trunc) %>%
    summarize(Frequency_Topic=n(),
              Frequency_Topic_Speeches=unique(Frequency_Topic_Speeches),
              Frequency_Speeches=unique(Frequency_Speeches),
              Words=unique(Words),
              Name=unique(Name)) %>%
    mutate(Primary_Topic=name)

  # cat(paste0("#### ",toupper("water_power"),"\n"))

  dtm_plot_topic <- ggplot() +
    geom_line(data=topic_docs,
              lwd=0.75,
              aes(x=Year,
                  y=Frequency_Speeches,
                  color=Primary_Topic,
                  group=1,
                  text=paste("<b>YEAR: </b>",Year,"    <b>TOPIC: </b>",name,
                             "<br><b>",Frequency_Speeches,"</b> of <b>",Frequency_Speeches,"</b> topic speeches (<b>",
                             round((Frequency_Speeches/Frequency_Speeches*100),1),"%</b>)"
                             # "<br>",str_trunc(Words,100),sep=""
                  ))) +
    geom_point(data=topic_docs,
               size=1.25,
               aes(x=Year,
                   y=Frequency_Speeches,
                   color=Primary_Topic,
                   group=1,
                  text=paste("<b>YEAR: </b>",Year,"    <b>TOPIC: </b>",name,
                             "<br><b>",Frequency_Speeches,"</b> of <b>",Frequency_Speeches,"</b> topic speeches (<b>",
                             round((Frequency_Speeches/Frequency_Speeches*100),1),"%</b>)"
                             # "<br>",str_trunc(Words,100),sep=""
                  ))) +
    geom_line(data=topic_docs,
            lwd=0.5,
            aes(x=Year,
                y=Frequency_Topic,
                color=Name_trunc,
                group=2,
                text=paste("<b>YEAR: </b>",Year,"    <b>TOPIC: </b>",n=Name,
                           "<br><b>",Frequency_Topic,"</b> of <b>",Frequency_Topic_Speeches,"</b>",
                           " </b>(<b>",round((Frequency_Topic/Frequency_Topic_Speeches*100),1),"%</b>) topic speeches",
                           " and <b>",Frequency_Speeches," </b>(<b>",round((Frequency_Topic/Frequency_Speeches*100),1),"%</b>) primary_topic speeches",
                           "<br>",str_trunc(Words,100),sep=""))) +
  geom_point(data=topic_docs,
             size=1,
             aes(x=Year,
                 y=Frequency_Topic,
                 color=Name_trunc,
                 group=2,
                text=paste("<b>YEAR: </b>",Year,"    <b>TOPIC: </b>",Name,
                           "<br><b>",Frequency_Topic,"</b> of <b>",Frequency_Topic_Speeches,"</b>",
                           " </b>(<b>",round((Frequency_Topic/Frequency_Topic_Speeches*100),1),"%</b>) topic speeches",
                           " and <b>",Frequency_Speeches," </b>(<b>",round((Frequency_Topic/Frequency_Speeches*100),1),"%</b>) primary_topic speeches",
                           "<br>",str_trunc(Words,100),sep=""))) +
  scale_colour_manual(values=c(unname(unname(alphabet2()),alphabet()),unname(polychrome()),unname(glasbey()),
                               unname(cols25()),unname(alphabet()),unname(alphabet2()),unname(polychrome()),unname(glasbey()))) +
  guides(color=guide_legend(title = "<b>TOPIC:</b>")) +
  theme_minimal() +
  theme(legend.title=element_text(family="EB Garamond", size=10,face="bold"), #color="#32127a",
        legend.text=element_text(family="EB Garamond", size=8),  #color="#32127a",
        plot.title=element_text(family="EB Garamond",hjust=0.5,size=18,face="bold"),  #color="#32127a",
        axis.title.x=element_blank(),
        axis.title.y=element_text(family="EB Garamond", size=16),  #color="#32127a",
        axis.text=element_text(family="EB Garamond",size=14),#,size=10),  #color="#32127a",
        strip.text=element_text(family="EB Garamond",face="bold"),
        panel.grid.major.x = element_line(),
        panel.grid.major.y = element_line(),
        panel.grid.minor.x = element_line(),
        panel.grid.minor.y = element_line())

##### make interactive
  ggplotly(dtm_plot_topic, tooltip="text", dynamicTicks=T) %>%
    style(hoverlabel=list(align="end",font=list(family="EB Garamond",size=11))) %>%
    
    layout(
      autosize=TRUE,
      font=list(family="EB Garamond"),
      legend=list(font=list(family="EB Garamond",size=10),
                  orientation='v',
                  # xanchor="center",
                  # x=0.5,
                  # y=-0.25,
                  # yanchor='top',
                  # yref="paper",
                  title=FALSE),
           xaxis = list(range=list(1885,2024),autorange=FALSE,
                        title=list(font=list(family="EB Garamond",size=12)),
                        tickfont=list(family="EB Garamond",size=10)),
           yaxis = list(title=list(font=list(family="EB Garamond",size=12)),
                        tickfont=list(family="EB Garamond",size=10))) %>%
    partial_bundle() %>%
    saveWidget(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_2yr_frequency_of_topic_",topic,".html",sep=""),selfcontained = F, libdir = "lib")

}

```

```{r vis 2-YEAR static plots, eval=FALSE}

TOPICS <- pull(topic_info,Topic)
trace <- 0

# for (trace in TRACES) {
for (topic in TOPICS) {
  
  trace <- trace+1

  ggplot() +
    geom_line(data= filter(dtm_2yr,Topic==topic),
              lwd=0.5,
              color="#32127a",
              aes(x=Year,
                  y=Frequency_Speeches)) +
    geom_point(data=filter(dtm_2yr,Topic==topic),
               size=1,
               color="#32127a",
               aes(x=Year,
                   y=Frequency_Speeches)) +
    ggtitle(paste(topic_info$Name[[trace]])) +
    # guides(color=guide_legend(title = "<b>TOPIC:</b>")) +
    scale_x_continuous(breaks = seq(1885, 2024, by = 8),
                       minor_breaks=seq(1885, 2024, by = 4),
                       limits=c(1885,2025)) +
    theme_minimal() +
    theme(
      legend.title=element_text(face="bold"), #color="#32127a",
      # legend.text=element_text(family="EB Garamond"),  #color="#32127a",
      plot.title=element_text(hjust=0.5,face="bold",size=9),  #color="#32127a",
      axis.title.x=element_blank(),
      axis.title.y=element_text(size=8),  #color="#32127a",
      axis.text=element_text(size=8),#,size=10),  #color="#32127a",
      # axis.line=element_line(color="#32127a"),
      # axis.ticks=element_line(color="#32127a"),
      # strip.text=element_text(family="EB Garamond",face="bold"),
      panel.grid.major.x = element_line(),
      panel.grid.major.y = element_line(),
      panel.grid.minor.x = element_line(),
      panel.grid.minor.y = element_line())
  ggsave(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_2yr_topic_",topic,".jpg",sep=""),
         scale=1,width = 6, height = 2, units="in")
  
  
  ggplot() +
    geom_line(data= filter(dtm_2yr,Topic==(topic)),
              lwd=0.5,
              color="#32127a",
              aes(x=Year,
                  y=Proportion_Total_Speeches)) +
    geom_point(data=filter(dtm_2yr,Topic==(topic)),
               size=1,
               color="#32127a",
               aes(x=Year,
                   y=Proportion_Total_Speeches)) +
    ggtitle(paste(topic_info$Name[[trace]])) +
    # guides(color=guide_legend(title = "<b>TOPIC:</b>")) +
    scale_x_continuous(breaks = seq(1885, 2024, by = 8),
                       minor_breaks=seq(1885, 2024, by = 4),
                       limits=c(1885,2025)) +
    theme_minimal() +
    theme(
      legend.title=element_text(face="bold"), #color="#32127a",
      # legend.text=element_text(family="EB Garamond"),  #color="#32127a",
      plot.title=element_text(hjust=0.5,face="bold",size=9),  #color="#32127a",
      axis.title.x=element_blank(),
      axis.title.y=element_text(size=8),  #color="#32127a",
      axis.text=element_text(size=8),#,size=10),  #color="#32127a",
      # axis.line=element_line(color="#32127a"),
      # axis.ticks=element_line(color="#32127a"),
      # strip.text=element_text(family="EB Garamond",face="bold"),
      panel.grid.major.x = element_line(),
      panel.grid.major.y = element_line(),
      panel.grid.minor.x = element_line(),
      panel.grid.minor.y = element_line())
  ggsave(paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_2yr_proportions_total_topic_",topic,".jpg",sep=""),
         scale=1,width = 6, height = 2, units="in")

  
}


```

```{r vis 2-YEAR html plots RESULTS, results="asis", echo=FALSE, cols.min.print=3,rows.print=5,rownames.print=FALSE}

# TRACES <- c(1:nrow(topic_info))
# topic <- 0

TOPICS <- pull(topic_info,Topic)
trace <- 0
table_list <- list()

# for (trace in TRACES) {
for (topic in TOPICS) {
  
  trace <- trace+1
  
  # cat(paste0("### Fig. ",trace,". ",topic_info$Name[topic_info$Topic==topic],"\n"))
  name <- str_extract(topic_info$Name[topic_info$Topic==topic],pattern="^[:digit:]+_[[:alpha:][:blank:]]+_[[:alpha:][:blank:]]+")
  cat(paste0("### ",name,"\n"))
  
  # outfile1 <-paste("MA_figures/dtm_2yr_topic_",topic,".html",sep="")
  # outfile2 <-paste("MA_figures/dtm_2yr_proportions_total_topic_",topic,".html",sep="")

  outfile1 <-paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_2yr_proportions_total_topic_",topic,".html",sep="")
  outfile2 <-paste("topic_models/enviroLabor/",size,"/",model_name,"/figures/dtm/dtm_2yr_frequency_of_topic_",topic,".html",sep="")

    print(htmltools::tags$iframe(
    src = outfile2,
    # scrolling = "no",
    frameBorder = "0",
    height=275,
    width="100%"

  ))

  print(htmltools::tags$iframe(
    src = outfile1,
    # scrolling = "no",
    frameBorder = "0",
    height=250,
    width="100%"
  ))

  
  table <- dtm_2yr %>%
    filter(Topic==topic) %>%
    select(Year,Frequency_Speeches,Words) %>%
    mutate(Year=as.numeric(Year),
           Frequency_Speeches=as.numeric(Frequency_Speeches)) %>%
    rename("Count"="Frequency_Speeches") %>%
    filter(Year>=1959 & Year<1990) %>%
    arrange(Year) %>%
    rmarkdown::paged_table()
  
  table_list[[trace]] <- table
  
  print(htmltools::tagList(DT::datatable(table_list[[trace]],
                                         rownames=FALSE,
                                         # filter="top")))
                                         options=list(#pageLength=5,
                                           lengthMenu = c(5, 10, 15, 20)))))

  topic <- topic+1
  
}


```

