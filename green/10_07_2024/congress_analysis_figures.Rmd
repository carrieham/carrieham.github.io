---
title: "CLC text mining"
output:
  html_document:
    pandoc_args:
    - +RTS
    - "-M64G"
    - "-RTS"
    code_folding: hide
    self_contained: no
    df_print: paged
    highlighter: haddock
    toc: true
    toc_float: true
    css: styles.css
    includes:
      in_header: header.html
---
<p>

<center><font size="3">`r Sys.Date()`</font></center>

</p>

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
#quanteda_options(tokens_block_size = 50000)

options(repos = list(CRAN="http://cran.rstudio.com/"))
install.packages("pacman")
library(pacman)

p_load(bookdown,
       data.table,
       DataTables,
       dplyr, 
       DT,
       forcats,
       ggrepel,
       htmlwidgets,
       lubridate,
       plotly,
       quanteda,
       stopwords,
       tictoc,
       tidyverse, 
       tidytext,
       tokenizers,
       vroom)

# library(reticulate)
# require(devtools)
# install_github("stephbuon/posextractr")
library(posextractr)
# posextract_install() #only run first time ever installing package
# virtualenv_create("r-posextract", python="3.12")
# py_install(c("pandas", "spacy", "posextract"), pip = TRUE)
# system(command = "python3 -m spacy download en_core_web_sm")
posextract_initialize()

widget_file_size <- function(p) {
  d <- tempdir()
  withr::with_dir(d, htmlwidgets::saveWidget(p, "index.html"))
  f <- file.path(d, "index.html")
  mb <- round(file.info(f)$size / 1e6, 3)
  message("File is: ", mb," MB")
}

create_dt <- function(x){
  DT::datatable(x,rownames=FALSE) #filter='top')
  # datatable(extensions = 'Buttons',
  #           options = list(dom = 'lfrtipB',
  #                          buttons = c('copy', 'csv', 'pdf'),
  #                          lengthMenu = list(c(10,25,50,-1),
  #                                            c(10,25,50,"All"))))
}

```

### DATA
```{r input data, include=FALSE, cache=TRUE, cache.lazy=FALSE}

load(verbose=TRUE,"data/enviroLaborSpeeches.Rda")

# enviroLaborSpeeches <- vroom("data/enviroLaborSpeeches.csv",
#                         show_col_types = FALSE) %>%
enviroLaborSpeeches <- enviroLaborSpeeches %>%
  as_tibble() %>%
  select(year,
         date,
         chamber,
         environment,
         labor,
         speech_id,
         speech,
         # last_name,
         # state,
         total_annual_speeches) %>%
  mutate(speech=str_remove(speech,"^of[:space:](Alabama|Alaska|Arizona|Arkansas|California|Colorado|Connecticut|Delaware|Florida|Georgia|Hawaii|Idaho|Illinois|Indiana|Iowa|Kansas|Kentucky|Louisiana|Maine|Maryland|Massachusetts|Michigan|Minnesota|Mississippi|Missouri|Montana|Nebraska|Nevada|New Hampshire|New Jersey|New Mexico|New York|North Carolina|North Dakota|Ohio|Oklahoma|Oregon|Pennsylvania|Rhode Island|South Carolina|South Dakota|Tennessee|Texas|Utah|Vermont|Virginia|Washington|West Virginia|Wisconsin|Wyoming)"),
         speech= str_remove(speech,"^[^[:alpha:]]*")) ###***CH added

# enviroLaborSpeeches <- enviroLaborSpeeches %>%
#   filter(is.na(year)==FALSE)
save(enviroLaborSpeeches,file="data/enviroLaborSpeeches.Rda")
fwrite(enviroLaborSpeeches,"data/enviroLaborSpeeches.csv")


stopwords_iso <- stopwords("en", source = "stopwords-iso") 
stopwords_manual <- c("absent","adjourn", "ask", "can", "chairman",
                       "committee","con","democrat","etc","gentleladies",
                       "gentlelady", "gentleman", "gentlemen", "gentlewoman",
                       "gentlewomen","hereabout","hereafter","hereat", "hereby",
                       "herein", "hereinafter", "hereinbefore", "hereinto", "hereof",
                       "hereon", "hereto", "heretofore", "hereunder", "hereunto",
                       "hereupon", "herewith", "month", "mr", "mrs", "nai", "nay",
                       "none", "now", "part", "per", "pro", "republican",
                       "say", "senator", "shall", "sir", "speak", "speaker",
                       "tell", "thank", "thereabout", "thereafter", "thereagainst",
                       "thereat", "therebefore", "therebeforn", "thereby", "therefor",
                       "therefore", "therefrom", "therein", "thereinafter", "thereof",
                       "thereon", "thereto", "theretofore", "thereunder", "thereunto",
                       "thereupon", "therewith", "therewithal", "today", "whereabouts",
                       "whereafter", "whereas", "whereat", "whereby","wherefore",
                       "wherefrom", "wherein", "whereinto", "whereof", "whereon","whereto",
                       "whereunder", "whereupon", "wherever", "wherewith", 
                       "wherewithal", "will", "yea", "yes", "yield")

stopwords_manual2 <- c("white house","white houses",
                       "avenue","street","nw","northwest","suite",
                       "number","numeric","sequence","sequences",
                       "add","addition","additions","adding","added",
                       "amend","amended","amendment","amendments","amending","amends",
                       "america","american","americas",
                       "bill","bills",
                       "chapter","chapters",
                       "code","codes",
                       "country","countrys", 
                       "congress","congressional",
                       "district of columbia","district","districts",
                       "enact","enacted","enacting","enacts",
                       "federal", 
                       "senate","senates", 
                       "house of representatives","representative","representatives","the house",
                       "insert","inserting","inserted","inserts",
                       "law","laws",
                       "legislation","legislative","legislator",
                       "paragraph","paragraphs","sentence","sentences",
                       "percent","percentage","percentages",
                       "president","presidents","presidential", 
                       "print","printing","printed","prints",
                       "record","recording","recorded","records",
                       "section","sections",
                       "united states",
                       "state","states",
                       "subchapter","subchapters",
                       "subsection","subsections",
                       "supreme court","supreme courts","court","courts",
                       "title","titles",
                       "unanimous consent","consent","consenting",
                       "united","u.s.","us",
                       "urge","urging","urged","urges",
                       "colleague","colleagues",
                       "washington", "d.c.")

stopwords <- c(stopwords_manual2,stopwords_manual,stopwords_iso)

```

```{r input tokens data, include=FALSE, cache=TRUE, cache.lazy=FALSE}

# load(verbose=TRUE,"data/R/enviroTokens.Rda")
# enviroTokens <- enviroTokens %>%
#   filter(is.na(year)==FALSE)
# save(enviroTokens,file="data/R/enviroTokens.Rda")

load(verbose=TRUE,"data/R/enviroBigrams.Rda")
# enviroBigrams <- enviroBigrams %>%
#   filter(is.na(year)==FALSE)
# save(enviroBigrams,file="data/R/enviroBigrams.Rda")

# load(verbose=TRUE,"data/R/enviro3grams.Rda")
# enviro3grams <- enviroTriples %>%
#   filter(is.na(year)==FALSE)
# save(enviro3grams,file="data/R/enviro3grams.Rda")



# load(verbose=TRUE,"data/R/laborTokens.Rda")
# laborTokens <- laborTokens %>%
#   filter(is.na(year)==FALSE)
# save(laborTokens,file="data/R/laborTokens.Rda")

load(verbose=TRUE,"data/R/laborBigrams.Rda")
# laborBigrams <- laborBigrams %>%
#   filter(is.na(year)==FALSE)
# save(laborBigrams,file="data/R/laborBigrams.Rda")

# load(verbose=TRUE,"data/R/labor3grams.Rda")
# labor3grams <- laborTriples %>%
#   filter(is.na(year)==FALSE)
# save(labor3grams,file="data/R/labor3grams.Rda")



# load(verbose=TRUE,"data/R/enviroLaborTokens.Rda")
# enviroLaborTokens <- enviroLaborTokens %>%
#   filter(is.na(year)==FALSE)
# save(enviroLaborTokens,file="data/R/enviroLaborTokens.Rda")

load(verbose=TRUE,"data/R/enviroLaborBigrams.Rda")
# enviroLaborBigrams <- enviroLaborBigrams %>%
#   filter(is.na(year)==FALSE)
# save(enviroLaborBigrams,file="data/R/enviroLaborBigrams.Rda")

# load(verbose=TRUE,"data/R/enviroLabor3grams.Rda")
# enviroLabor3grams <- enviroLaborTriples %>%
#   filter(is.na(year)==FALSE)
# save(enviroLabor3grams,file="data/R/enviroLabor3grams.Rda")

```

#### [1] environmental/labor speeches
1873-2016: [stanford hein project](https://data.stanford.edu/congress_text).
+   download bound edition speeches (1873-198?)
+   download daily edition speeches (1981-2016)
+   subset to enviro/labor speeches

2016-2024: [congress.gov](https://www.congress.gov/search?q=%7B%22source%22%3A%22congrecord%22%7D)
+   daily edition speeches scraped
+   scraping tool built using modification of Devin Judge-Lord's [congressionalrecord R package](https://judgelord.github.io/congressionalrecord/) functions
+   3x steps:
    +   download metadata
    +   download htm files
    +   convert to txt files
+   process + clean speeches using methods comparable to stanford hein project
+   subset to enviro/labor speeches



### APPROACH
#### [1] join hein bound/daily speeches with desc metadata files

#### [2] merge hein bound/daily speeches with desc metadata files

#### [3] scrape congress.gov for 2016-2024

#### [4] merge hein and congress.gov data for full 1873-2024 dataset

#### [5] subset to speeches with at least one environmental or labor keyword

#### [6] tokenize + remove stop words
##### create tokens

```{r enviro tokens, message=FALSE, results=FALSE, cache=TRUE}

##### TOKENS #####
tic()
enviroTokens <- enviroLaborSpeeches %>%
  filter(environment=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=TRUE,
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         verbose=TRUE,
         xptr=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

#####SAVE FILE
save(enviroTokens,file="data/R/enviroTokens.Rda")

```

```{r enviro bigrams, message=FALSE, results=FALSE, cache=TRUE, lazy.cache=FALSE}

# ##### BIGRAMS #####
tic()
enviroBigrams <- enviroLaborSpeeches %>%
  filter(environment=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=FALSE, #CREATE TOKEN OBJECT
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         xptr=TRUE,
         verbose=TRUE) %>%
  tokens_remove("\\p{P}", valuetype = "regex", #REMOVE PUNCT
                padding=TRUE, #REPLACE W/ EMPTY STRINGS
                verbose=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  tokens_ngrams(n=2) %>% #CREATE BIGRAMS
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()
#
# ##### SAVE FILE
save(enviroBigrams,file="data/R/enviroBigrams.Rda")

```

```{r enviro 3-grams, message=FALSE, results=FALSE, cache=TRUE, lazy.cache=FALSE}

##### 3-grams #####
tic()
enviro3grams <- enviroLaborSpeeches %>%
  filter(environment=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=FALSE, #CREATE TOKEN OBJECT
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         xptr=TRUE,
         verbose=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  tokens_remove("\\p{P}", valuetype = "regex", #REMOVE PUNCT
                padding=TRUE, #REPLACE W/ EMPTY STRINGS
                verbose=TRUE) %>%
  tokens_ngrams(n=3) %>% #CREATE TRIPLES
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

# ##### SAVE FILE
save(enviro3grams,file="data/R/enviro3grams.Rda")

```

```{r labor tokens, message=FALSE, results=FALSE, cache=TRUE, lazy.cache=FALSE}

##### TOKENS #####
tic()
laborTokens <- enviroLaborSpeeches %>%
  filter(labor=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=TRUE,
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         verbose=TRUE,
         xptr=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

##### SAVE FILE
save(laborTokens,file="data/R/laborTokens.Rda")

```

```{r labor bigrams, message=FALSE, results=FALSE, cache=TRUE, lazy.cache=FALSE}

##### BIGRAMS #####
tic()
laborBigrams <- enviroLaborSpeeches %>%
  filter(labor=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=FALSE, #CREATE TOKEN OBJECT
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         xptr=TRUE,
         verbose=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  tokens_remove("\\p{P}", valuetype = "regex", #REMOVE PUNCT
                padding=TRUE, #REPLACE W/ EMPTY STRINGS
                verbose=TRUE) %>%
  tokens_ngrams(n=2) %>% #CREATE BIGRAMS
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

##### SAVE FILE
save(laborBigrams,file="data/R/laborBigrams.Rda")

```

```{r labor 3-grams, message=FALSE, results=FALSE, cache=TRUE, lazy.cache=FALSE}

##### 3-grams #####
tic()
labor3grams <- enviroLaborSpeeches %>%
  filter(labor=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=FALSE, #CREATE TOKEN OBJECT
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         xptr=TRUE,
         verbose=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  tokens_remove("\\p{P}", valuetype = "regex", #REMOVE PUNCT
                padding=TRUE, #REPLACE W/ EMPTY STRINGS
                verbose=TRUE) %>%
  tokens_ngrams(n=3) %>% #CREATE TRIPLES
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

##### SAVE FILE
save(labor3grams,file="data/R/labor3grams.Rda")

```

```{r enviroLabor tokens, message=FALSE, results=FALSE, cache=TRUE}

##### TOKENS #####
tic()
enviroLaborTokens <- enviroLaborSpeeches %>%
  filter(environment=="Yes" & labor=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=TRUE,
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         verbose=TRUE,
         xptr=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

##### SAVE FILE
save(enviroLaborTokens,file="data/R/enviroLaborTokens.Rda")

```

```{r enviroLabor bigrams, message=FALSE, results=FALSE, cache=TRUE, lazy.cache=FALSE}

##### BIGRAMS #####
tic()
enviroLaborBigrams <- enviroLaborSpeeches %>%
  filter(environment=="Yes" & labor=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=FALSE, #CREATE TOKEN OBJECT
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         xptr=TRUE,
         verbose=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  tokens_remove("\\p{P}", valuetype = "regex", #REMOVE PUNCT
                padding=TRUE, #REPLACE W/ EMPTY STRINGS
                verbose=TRUE) %>%
  tokens_ngrams(n=2) %>% #CREATE BIGRAMS
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

##### SAVE FILE
save(enviroLaborBigrams,file="data/R/enviroLaborBigrams.Rda")

```

```{r enviroLabor 3-grams, message=FALSE, results=FALSE, cache=TRUE, lazy.cache=FALSE}

##### 3-grams #####
tic()
enviroLabor3grams <- enviroLaborSpeeches %>%
  filter(environment=="Yes" & labor=="Yes") %>%
  corpus(docid_field="speech_id",
         text_field="speech") %>%
  tokenize_word_stems(stopwords=stopwords) %>%
  tokens(remove_punct=FALSE, #CREATE TOKEN OBJECT
         split_tags=TRUE,
         split_elisions=TRUE,
         remove_symbols=TRUE,
         remove_numbers=TRUE,
         remove_separators=TRUE,
         padding=FALSE,
         xptr=TRUE,
         verbose=TRUE) %>%
  # tokens_remove(stopwords, #REMOVE STOP WORDS BEFORE TRIPLES CREATED
  #               padding=FALSE,
  #               verbose=TRUE) %>%
  tokens_remove("\\p{P}", valuetype = "regex", #REMOVE PUNCT
                padding=TRUE, #REPLACE W/ EMPTY STRINGS
                verbose=TRUE) %>%
  tokens_ngrams(n=3) %>% #CREATE TRIPLES
  dfm() %>% #CREATE DOC-TERM MATRIX
  tidy() %>%
  mutate(speech_id=as.double(document)) %>%
  left_join(enviroLaborSpeeches %>% select(year,date,speech_id,environment,labor),by=join_by(speech_id==speech_id)) %>%
  as_tibble()
toc()

#####SAVE FILE
save(enviroLabor3grams,file="data/R/enviroLabor3grams.Rda")

```

### ANALYSIS: SPEECHES
##### environmental speeches per year:
```{r envt speech counts, echo=FALSE, cache=TRUE}

enviroSpeeches_byYear <- enviroLaborSpeeches %>%
  filter(environment=="Yes") %>%
  group_by(year) %>%
  summarize(n=n(),prop=n/unique(total_annual_speeches)) %>%
  arrange(desc(year))

map_enviroSpeeches_byYear <- ggplot() +
  # geom_col(data=enviroSpeeches_byYear,
  #          aes(x=year,y=n,
  #              text=paste("<b>",year,":</b> ",n," speeches",sep="")),
  #          fill="aquamarine4") +
  geom_line(data=enviroSpeeches_byYear,
            aes(x=year,
                y=n,
                group=1,
                text=paste("<b>",year,":</b> ",n," speeches",sep="")),
            color="aquamarine4") +
  scale_x_discrete(breaks = seq(1880, 2020, by = 10)) + 
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

##### make interactive
ggplotly(map_enviroSpeeches_byYear, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviro_speeches_by_year.html", selfcontained = F, libdir = "lib")
```

```{r envt speech proportions, echo=FALSE, cache=TRUE}

map_enviroSpeeches_prop_byYear <- ggplot() +
  # geom_col(data=enviroSpeeches_byYear,
  #          aes(x=year,y=prop,
  #              text=paste("<b>",year,":</b> ",round(prop*100,1),"% of speeches",sep="")),
  #          fill="aquamarine4") +
  geom_line(data=enviroSpeeches_byYear,
            aes(x=year,
                y=prop,
                group=1,
                text=paste("<b>",year,":</b> ",round(prop*100,1),"% of speeches",sep="")),
            color="aquamarine4") +
  scale_x_discrete(breaks = seq(1880, 2020, by = 10)) + 
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

##### make interactive
ggplotly(map_enviroSpeeches_prop_byYear, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviro_speeches_prop_by_year.html", selfcontained = F, libdir = "lib")

```

##### labor speeches per year:
```{r labor speech counts, echo=FALSE, cache=TRUE}

laborSpeeches_byYear <- enviroLaborSpeeches %>%
  filter(labor=="Yes") %>%
  group_by(year) %>%
  summarize(n=n(),prop=n/unique(total_annual_speeches)) %>%
  arrange(desc(year))

map_laborSpeeches_byYear <- ggplot() +
  # geom_col(data=laborSpeeches_byYear,
  #          aes(x=year,y=n,
  #              text=paste("<b>",year,":</b> ",n," speeches",sep="")),
  #          fill="blueviolet") +
  geom_line(data=laborSpeeches_byYear,
            aes(x=year,
                y=n,
                group=1,
                text=paste("<b>",year,":</b> ",n," speeches",sep="")),
            color="blueviolet") +
  scale_x_discrete(breaks = seq(1880, 2020, by = 10)) + 
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

##### make interactive
ggplotly(map_laborSpeeches_byYear, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/labor_speeches_by_year.html", selfcontained = F, libdir = "lib")

```

```{r labor speech proportions, echo=FALSE, cache=TRUE}

map_laborSpeeches_prop_byYear <- ggplot() +
  # geom_col(data=laborSpeeches_byYear,
  #          aes(x=year,y=prop,
  #              text=paste("<b>",year,":</b> ",round(prop*100,1),"% of speeches",sep="")),
  #          fill="blueviolet") +
  geom_line(data=laborSpeeches_byYear,
            aes(x=year,
                y=prop,
                group=1,
                text=paste("<b>",year,":</b> ",round(prop*100,1),"% of speeches",sep="")),
            color="blueviolet") +
  scale_x_discrete(breaks = seq(1880, 2020, by = 10)) + 
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

##### make interactive
ggplotly(map_laborSpeeches_prop_byYear, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/labor_speeches_prop_by_year.html", selfcontained = F, libdir = "lib")

```

##### enviro-labor speeches per year:
```{r enviro-labor speech counts, echo=FALSE, cache=TRUE}

enviroLaborSpeeches_byYear <- enviroLaborSpeeches %>%
  filter(environment=="Yes" & labor=="Yes") %>%
  group_by(year) %>%
  summarize(n=n(),prop=n/unique(total_annual_speeches)) %>%
  arrange(desc(year))

map_enviroLaborSpeeches_byYear <- ggplot() +
    # geom_col(data=enviroLaborSpeeches_byYear,
    #          aes(x=year,y=n,
    #              text=paste("<b>",year,":</b> ",n," speeches",sep="")),
    #          fill="darkslateblue") +
    geom_line(data=enviroLaborSpeeches_byYear,
            aes(x=year,
                y=n,
                group=1,
                text=paste("<b>",year,":</b> ",n," speeches",sep="")),
            color="darkslateblue") +
  scale_x_discrete(breaks = seq(1880, 2020, by = 10)) + 
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

##### make interactive
ggplotly(map_enviroLaborSpeeches_byYear, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviroLabor_speeches_by_year.html", selfcontained = F, libdir = "lib")

```

```{r enviroLabor speech proportions, echo=FALSE, cache=TRUE}

enviroLaborSpeeches_prop_byYear <- enviroLaborSpeeches %>%
  filter(environment=="Yes" & labor=="Yes") %>%
  group_by(year) %>%
  summarize(prop=n()/total_annual_speeches) %>%
  arrange(desc(year))

map_enviroLaborSpeeches_prop_byYear <- ggplot() +
  # geom_col(data=enviroLaborSpeeches_byYear,
  #          aes(x=year,y=prop,
  #              text=paste("<b>",year,":</b> ",round(prop*100,1),"% of speeches",sep="")),
  #          fill="darkslateblue") +
  geom_line(data=enviroLaborSpeeches_byYear,
            aes(x=year,
                y=prop,
                group=1,
                text=paste("<b>",year,":</b> ",round(prop*100,1),"% of speeches",sep="")),
            color="darkslateblue") +
  scale_x_discrete(breaks = seq(1880, 2020, by = 10)) + 
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

##### make interactive
ggplotly(map_enviroLaborSpeeches_prop_byYear, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
 saveWidget("figures/enviroLabor_speeches_prop_by_year.html", selfcontained = F, libdir = "lib")

```

```{r all speeches over time, echo=FALSE, cache=TRUE}

allSpeeches_byYear <- rbind(mutate(enviroSpeeches_byYear,type="environment"),
                            mutate(laborSpeeches_byYear,type="labor"),
                            mutate(enviroLaborSpeeches_byYear,type="enviro-labor"))
map_allSpeeches_prop_byYear <- ggplot() +
geom_line(data=allSpeeches_byYear,
              aes(x=year,
                  y=prop,
                  group=3,
                  color=type,
                  text=paste("<b>",year,":</b> ",round(prop*100,1),"% of speeches",sep=""))) +
  scale_color_manual(values=c("environment"="aquamarine4",
                              "labor"="blueviolet",
                              "enviro-labor"="darkslateblue")) +
  guides(color=guide_legend(title = "")) +
  scale_x_discrete(breaks = seq(1880, 2020, by = 10)) + 
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

##### make interactive
ggplotly(map_allSpeeches_prop_byYear, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         legend=list(xref="paper",
                     x=0.5,xanchor='center',
                     y=1,yanchor='top',
                     orientation='h',
                     traceorder="reversed",
                     title=list(font=list(color="#32127a",family="IBM Plex Mono")),
                     font=list(color="#32127a",family="IBM Plex Mono"))) %>%
  partial_bundle() %>%
  saveWidget("figures/speeches_prop_by_year.html", selfcontained = F, libdir = "lib")

```


### ANALYSIS: TOKENS
#### token counts
##### top 25 enviro tokens
```{r enviro token counts, echo=FALSE, cache=FALSE, cache.lazy = FALSE}
enviroTokens_top25 <- enviroTokens %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(enviroTokens_count,file="data/R/tables/enviroTokens_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroTokens_top25.Rda")

map_enviroTokens_top25 <- ggplot() +
    geom_col(data=enviroTokens_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             fill="aquamarine4") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


##### make interactive
ggplotly(map_enviroTokens_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviro_tokens_top25.html", selfcontained = F, libdir = "lib")
```

##### top 25 labor tokens
```{r labor token counts, echo=FALSE, cache=FALSE, cache.lazy = FALSE}
laborTokens_top25 <- laborTokens %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(laborTokens_count,file="data/R/tables/laborTokens_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/laborTokens_top25.Rda")

map_laborTokens_top25 <- ggplot() +
    geom_col(data=laborTokens_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             #color="blueviolet",
             fill="blueviolet") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


##### make interactive
ggplotly(map_laborTokens_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("labor_tokens_top25.html", selfcontained = F, libdir = "lib")
```

##### top 25 enviro-labor tokens
```{r enviroLabor token counts, echo=FALSE, cache=FALSE, cache.lazy = FALSE}

enviroLaborTokens_top25 <- enviroLaborTokens %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(enviroLaborTokens_top25,file="data/R/tables/enviroLaborTokens_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroLaborTokens_count.Rda")

map_enviroLaborTokens_top25 <- ggplot() +
    geom_col(data=enviroLaborTokens_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             #color="blueviolet",
             fill="darkslateblue") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


##### make interactive
ggplotly(map_enviroLaborTokens_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviroLabor_tokens_top25.html", selfcontained = F, libdir = "lib")

```


#### bigram counts
##### top 25 enviro bigrams
```{r enviro bigram counts, message=FALSE, cache=FALSE, cache.lazy = FALSE}

enviroBigrams_top25 <- enviroBigrams %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(enviroBigrams_top25,file="data/R/tables/enviroBigrams_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroBigrams_top25.Rda")

map_enviroBigrams_top25 <- ggplot() +
    geom_col(data=enviroBigrams_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             fill="aquamarine4") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())



##### make interactive
ggplotly(map_enviroBigrams_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviro_bigrams_top25.html", selfcontained = F, libdir = "lib")

```

##### top 25 labor bigrams
```{r labor bigram counts, echo=FALSE, cache=FALSE, cache.lazy = FALSE}
laborBigrams_top25 <- laborBigrams %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(laborBigrams_top25,file="data/R/tables/laborBigrams_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/laborBigrams_top25.Rda")

map_laborBigrams_top25 <- ggplot() +
    geom_col(data=laborBigrams_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             #color="blueviolet",
             fill="blueviolet") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


##### make interactive
ggplotly(map_laborBigrams_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/labor_bigrams_top25.html", selfcontained = F, libdir = "lib")
```

##### top 25 enviro-labor bigrams
```{r enviroLabor bigram counts, echo=FALSE, cache=FALSE, cache.lazy = FALSE}

enviroLaborBigrams_top25 <- enviroLaborBigrams %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(enviroLaborBigrams_top25,file="data/R/tables/enviroLaborBigrams_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroLaborBigrams_count.Rda")

map_enviroLaborBigrams_top25 <- ggplot() +
    geom_col(data=enviroLaborBigrams_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             #color="blueviolet",
             fill="darkslateblue") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


##### make interactive
ggplotly(map_enviroLaborBigrams_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviroLabor_bigrams_top25.html", selfcontained = F, libdir = "lib")

```


#### 3-gram counts
##### top 25 enviro 3-grams
```{r enviro 3-gram counts, message=FALSE, cache=FALSE, cache.lazy = FALSE}

enviro3grams_top25 <- enviro3grams %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(enviro3grams_top25,file="data/R/tables/enviro3grams_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/enviro3grams_top25.Rda")

map_enviro3grams_top25 <- ggplot() +
    geom_col(data=enviro3grams_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             fill="aquamarine4") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())



##### make interactive
ggplotly(map_enviro3grams_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviro_3grams_top25.html", selfcontained = F, libdir = "lib")

```

##### top 25 labor 3-grams
```{r labor 3-gram counts, echo=FALSE, cache=FALSE, cache.lazy = FALSE}

labor3grams_top25 <- labor3grams %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(labor3grams_top25,file="data/R/tables/labor3grams_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/labor3grams_top25.Rda")

map_labor3grams_count <- ggplot() +
    geom_col(data=labor3grams_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             #color="blueviolet",
             #fill="lightslateblue") +
             fill="blueviolet") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


##### make interactive
ggplotly(map_labor3grams_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/labor_3grams_top25.html", selfcontained = F, libdir = "lib")

```

##### top 25 enviro-labor 3-grams
```{r enviroLabor 3-gram counts, echo=FALSE, cache=FALSE, cache.lazy = FALSE}

enviroLabor3grams_top25 <- enviroLabor3grams %>%
  as_tibble() %>%
  count(term,wt=count) %>%
  top_n(25) %>%
  arrange(desc(n))
save(enviroLabor3grams_top25,file="data/R/tables/enviroLabor3grams_top25.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroLabor3grams_top25.Rda")

map_enviroLabor3grams_top25 <- ggplot() +
    geom_col(data=enviroLabor3grams_top25,
             aes(x=fct_reorder(term,n),
                 y=n,
                 text=paste("<b>",term,":</b> ",n,sep="")),
             #color="blueviolet",
             fill="darkslateblue") +
  coord_flip() +
  theme_minimal() +
  theme(axis.line=element_line(color="#32127a"),
        axis.ticks=element_line(color="#32127a"),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


##### make interactive
ggplotly(map_enviroLabor3grams_top25, tooltip="text") %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  partial_bundle() %>%
  saveWidget("figures/enviroLabor_3grams_top25.html", selfcontained = F, libdir = "lib")

```


#### tokens by year
##### top 10 enviro tokens by year
```{r enviro token counts by year, message=FALSE, cache=TRUE}

enviro_tokens_by_year <- enviroTokens %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(enviro_tokens_by_year,file="data/R/tables/enviro_tokens_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/enviro_tokens_by_year.Rda")

```

##### top 10 labor tokens by year
```{r labor token counts by year, message=FALSE, cache=TRUE}

labor_tokens_by_year <- laborTokens %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))

save(labor_tokens_by_year,file="data/R/tables/labor_tokens_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/labor_tokens_by_year.Rda")

```

##### top 10 enviroLabor tokens by year
```{r enviroLabor token counts by year, message=FALSE, cache=TRUE}

enviroLabor_tokens_by_year <- enviroLaborTokens %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(enviroLabor_tokens_by_year,file="data/R/tables/enviroLabor_tokens_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroLabor_tokens_by_year.Rda")

```

##### top 10 enviro bigrams by year
```{r enviro bigram counts by year, message=FALSE, cache=TRUE}

enviro_bigrams_by_year <- enviroBigrams %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(enviro_bigrams_by_year,file="data/R/tables/enviro_bigrams_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/enviro_bigrams_by_year.Rda")

```

##### top 10 labor bigrams by year
```{r labor bigram counts by year, message=FALSE, cache=TRUE}

labor_bigrams_by_year <- laborBigrams %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(labor_bigrams_by_year,file="data/R/tables/labor_bigrams_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/labor_bigrams_by_year.Rda")

```

##### top 10 enviroLabor bigrams by year
```{r enviroLabor bigram counts by year, message=FALSE, cache=TRUE}

enviroLabor_bigrams_by_year <- enviroLaborBigrams %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(enviroLabor_bigrams_by_year,file="data/R/tables/enviroLabor_bigrams_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroLabor_bigrams_by_year.Rda")

```

##### top 10 enviro 3-grams by year
```{r enviro 3-gram counts by year, message=FALSE, cache=TRUE}

enviro_3grams_by_year <- enviro3grams %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(enviro_triples_by_year,file="data/R/tables/enviro_3grams_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/enviro_3grams_by_year.Rda")
```

##### top 10 labor 3-grams by year
```{r labor 3-gram counts by year, message=FALSE, cache=TRUE}

labor_3grams_by_year <- labor3grams %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(labor_3grams_by_year,file="data/R/tables/labor_3grams_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/labor_3grams_by_year.Rda")

```

##### top 10 enviroLabor 3-grams by year
```{r enviroLabor 3-gram counts by year, message=FALSE, cache=TRUE}

enviroLabor_3grams_by_year <- enviroLabor3grams %>%
  group_by(year) %>%
  count(term,wt=count) %>%
  top_n(10) %>%
  arrange(desc(year),desc(n))
save(enviroLabor_3grams_by_year,file="data/R/tables/enviroLabor_3grams_by_year.Rda")

# load(verbose=TRUE,file="data/R/tables/enviroLabor_3grams_by_year.Rda")

```


###ANALYSIS: PART II
#### tp-ipf

```{r enviroLabor tf-ipf}

# ARCHITECTURE:
# a count of words per debate per speechdate is set up.
# tf-idf is calculated based on relative co-occurrence.

# the code cycles through big periods of years (5, 10, 20)
# and attempts to show the difference between tf-idf measures and raw count

# a second loop looks at smaller time periods (words relatively unique to a month, day ,etc.)

##### ENVIRO-enviroLabor #####
description <- "figures/enviroLaborBigrams-tfidf"
enviroLaborBigrams_60 <- enviroLaborBigrams %>%
  filter(year>="1960")
years <- as.tibble(unique(enviroLaborBigrams_60$year))
firstyear <- min(years$value)
lastyear <- max(years$value)
numyears <- nrow(years)

enviroLaborBigrams_count <- enviroLaborBigrams_60 %>%
  group_by(year,term) %>%
  count(term,wt=count) %>%
  filter(n>3)

# cycles through term counts by month, 6 month, year, etc.  
for (yrs in c(2, 5, 10, 20)) {
  
  ### count tfidf with n years as "document"
  print(paste0("counting tfidf by a ", yrs, "-year period"))
  enviroLabor_oneRowPerDocument <- enviroLaborBigrams_count %>%
    mutate(period = as.numeric(year) - as.numeric(year) %% yrs) %>%
    group_by(period, term) %>%
    dplyr::summarize(count = sum(n)) %>%
    ungroup() %>%
    mutate(id_number = period) %>%
    filter(!is.na(period)) %>%
    filter(!is.na(term)) %>%
    filter(!is.na(id_number))
  
  enviroLabor_tfidf <- enviroLabor_oneRowPerDocument %>%
    bind_tf_idf(term, id_number, count) %>%
    arrange(desc(tf_idf))
  
  enviroLabor_top_debates <- enviroLabor_tfidf %>%
    arrange(desc(tf_idf)) %>%
    slice(seq_len(25)) 
  
  # top_n_debates <- top_debates %>%
  #   slice(seq_len(10))
  
  enviroLabor_distinguished_words_stacked <- enviroLabor_top_debates %>%
    ggplot(aes(x = period,
               y = count,#tf_idf,
               text = paste("<b>",term,"</b>",
                            "<br>period: ",
                            period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""),
               label = term)) +
    geom_col(fill="darkslateblue",aes(alpha=tf_idf)) +
    guides(fill=FALSE) + #alpha=FALSE
    geom_label_repel(
      color = "#32127a",
      fill="white",
      size=3.5,
      label.padding=unit(0.1,"lines"),
      alpha=0.75,
      family="IBM Plex Mono",
      fontface = "bold",
      force = 2,
      label.size = 0.1,
      position = position_stack(vjust = 0.5)) +
    labs(title = paste0("top 25 distinguishing words in enviroLabor speeches per ", yrs, "-yr period")) +
    theme_minimal() +
    theme(plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      legend.title=element_text(family="IBM Plex Mono",color="#32127a"),
      legend.text=element_text(family="IBM Plex Mono",color="#32127a"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
    
  ggsave(paste0(description, "_stacked--", yrs, "yr.jpg"),
         w=9.5,h=11,units = "in") #h=11,
  
  # bar chart of top tf-idf words per period
  enviroLabor_top_debates_per_unit <- enviroLabor_tfidf %>%
    group_by(period) %>%
    arrange(desc(tf_idf)) %>%
    slice(seq_len(10)) %>%
    ungroup() 
  
  if (yrs==2) {
      enviroLabor_distinguished_words_facet <- ggplot(enviroLabor_top_debates_per_unit,
           aes(y = count,
               x = reorder_within(term, 
                                  count, 
                                  period, 
                                  fun = sum),
               # alpha=tf_idf,
               text = paste("<b>",term,"</b>",
                            # "<br>period: ",
                            # period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""))) +
    geom_col(fill="darkslateblue") +
    facet_wrap(~period, scales = "free", ncol=2) +
    scale_x_reordered() +
    coord_flip() +
    guides(fill=FALSE, color = FALSE, line = FALSE) +
    labs(title = paste0("words that distinguished enviroLabor speeches per ", yrs, "-yr period"),
         # subtitle = paste0("differential attention is calculated by tf-idf, using temporal period (", yrs, " yr) as the 'document'"),
         y = "count",
         x = "keyword") +
    theme_minimal() +
    theme(#aspect.ratio=8/11,
      plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),#,size=10),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      strip.text=element_text(family="IBM Plex Mono",color="#32127a",face="bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
  
  ggsave(paste0(description, "--", yrs, "yr.jpg"),
          w =9.5, h=24, units = "in") #h=11,
  }
  
  else {
  enviroLabor_distinguished_words_facet <- ggplot(enviroLabor_top_debates_per_unit,
           aes(y = count,
               x = reorder_within(term, 
                                  count, 
                                  period, 
                                  fun = sum),
               # alpha=tf_idf,
               text = paste("<b>",term,"</b>",
                            # "<br>period: ",
                            # period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""))) +
    geom_col(fill="darkslateblue") +
    facet_wrap(~period, scales = "free", ncol=2) +
    scale_x_reordered() +
    coord_flip() +
    guides(fill=FALSE, color = FALSE, line = FALSE) +
    labs(title = paste0("words that distinguished enviroLabor speeches per ", yrs, "-yr period"),
         # subtitle = paste0("differential attention is calculated by tf-idf, using temporal period (", yrs, " yr) as the 'document'"),
         y = "count",
         x = "keyword") +
    theme_minimal() +
    theme(#aspect.ratio=8/11,
      plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),#,size=10),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      strip.text=element_text(family="IBM Plex Mono",color="#32127a",face="bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
  
  ggsave(paste0(description, "--", yrs, "yr.jpg"),
          w =9.5, h=11, units = "in") #h=11,
  } 
 


##### make interactive
if (yrs==20) {
  
  ggplotly(enviroLabor_distinguished_words_facet, tooltip="text", dynamicTicks = FALSE) %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  saveWidget(paste0(description,"--",yrs,"yr.html"),selfcontained = F)
  
}

    
  # # make interactive
  # ggplotly(enviroLabor_distinguished_words_stacked, 
  #          tooltip="text", dynamicTicks = FALSE) %>%
  #          # mode='lines+markers+text') %>%
  # style(#mode="lines+markers",
  #       hoverlabel=list(font=list(family="IBM Plex Mono",
  #                                 size=11))) %>%
  # layout(font=list(color="#32127a",family="IBM Plex Mono"),
  #        xaxis=list(color="#32127a",
  #                   linecolor="#32127a",
  #                   tickfont=list(color="#32127a")),
  #        yaxis=list(color="#32127a",
  #                   linecolor="#32127a",
  #                   tickfont=list(color="#32127a"))) %>%
  # saveWidget(paste0(description, "_stacked--", yrs, "yr.html"),selfcontained = F)
  #   
}

```

```{r enviro tf-ipf}

# ARCHITECTURE:
# a count of words per debate per speechdate is set up.
# tf-idf is calculated based on relative co-occurrence.

# the code cycles through big periods of years (5, 10, 20)
# and attempts to show the difference between tf-idf measures and raw count

# a second loop looks at smaller time periods (words relatively unique to a month, day ,etc.)

##### ENVIRO-enviro #####
description <- "figures/enviroBigrams-tfidf"
enviroBigrams_60 <- enviroBigrams %>%
  filter(year>="1960")
years <- as.tibble(unique(enviroBigrams_60$year))
firstyear <- min(years$value)
lastyear <- max(years$value)
numyears <- nrow(years)

enviroBigrams_count <- enviroBigrams_60 %>%
  group_by(year,term) %>%
  count(term,wt=count) %>%
  filter(n>3)

# cycles through term counts by month, 6 month, year, etc.  
for (yrs in c(2, 5, 10, 20)) {
  
  ### count tfidf with n years as "document"
  print(paste0("counting tfidf by a ", yrs, "-year period"))
  enviro_oneRowPerDocument <- enviroBigrams_count %>%
    mutate(period = as.numeric(year) - as.numeric(year) %% yrs) %>%
    group_by(period, term) %>%
    dplyr::summarize(count = sum(n)) %>%
    ungroup() %>%
    mutate(id_number = period) %>%
    filter(!is.na(period)) %>%
    filter(!is.na(term)) %>%
    filter(!is.na(id_number))
  
  enviro_tfidf <- enviro_oneRowPerDocument %>%
    bind_tf_idf(term, id_number, count) %>%
    arrange(desc(tf_idf))
  
  enviro_top_debates <- enviro_tfidf %>%
    arrange(desc(tf_idf)) %>%
    slice(seq_len(25)) 
  
  # top_n_debates <- top_debates %>%
  #   slice(seq_len(10))
  
  enviro_distinguished_words_stacked <- enviro_top_debates %>%
    ggplot(aes(x = period,
               y = count,#tf_idf,
               text = paste("<b>",term,"</b>",
                            "<br>period: ",
                            period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""),
               label = term)) +
    geom_col(fill="aquamarine4",aes(alpha=tf_idf)) +
    guides(fill=FALSE) + #alpha=FALSE
    geom_label_repel(
      color = "#32127a",
      fill="white",
      size=3.5,
      label.padding=unit(0.1,"lines"),
      alpha=0.75,
      family="IBM Plex Mono",
      fontface = "bold",
      force = 2,
      label.size = 0.1,
      position = position_stack(vjust = 0.5)) +
    labs(title = paste0("top 25 distinguishing words in enviro speeches per ", yrs, "-yr period")) +
    theme_minimal() +
    theme(plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      legend.title=element_text(family="IBM Plex Mono",color="#32127a"),
      legend.text=element_text(family="IBM Plex Mono",color="#32127a"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
    
  ggsave(paste0(description, "_stacked--", yrs, "yr.jpg"),
         w=9.5,h=11,units = "in") #h=11,
  
  # bar chart of top tf-idf words per period
  enviro_top_debates_per_unit <- enviro_tfidf %>%
    group_by(period) %>%
    arrange(desc(tf_idf)) %>%
    slice(seq_len(10)) %>%
    ungroup() 
  
  if (yrs==2) {
      enviro_distinguished_words_facet <- ggplot(enviro_top_debates_per_unit,
           aes(y = count,
               x = reorder_within(term, 
                                  count, 
                                  period, 
                                  fun = sum),
               # alpha=tf_idf,
               text = paste("<b>",term,"</b>",
                            # "<br>period: ",
                            # period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""))) +
    geom_col(fill="aquamarine4") +
    facet_wrap(~period, scales = "free", ncol=2) +
    scale_x_reordered() +
    coord_flip() +
    guides(fill=FALSE, color = FALSE, line = FALSE) +
    labs(title = paste0("words that distinguished enviro speeches per ", yrs, "-yr period"),
         # subtitle = paste0("differential attention is calculated by tf-idf, using temporal period (", yrs, " yr) as the 'document'"),
         y = "count",
         x = "keyword") +
    theme_minimal() +
    theme(#aspect.ratio=8/11,
      plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),#,size=10),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      strip.text=element_text(family="IBM Plex Mono",color="#32127a",face="bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
  
  ggsave(paste0(description, "--", yrs, "yr.jpg"),
          w =9.5, h=24, units = "in") #h=11,
  }
  
  else {
  enviro_distinguished_words_facet <- ggplot(enviro_top_debates_per_unit,
           aes(y = count,
               x = reorder_within(term, 
                                  count, 
                                  period, 
                                  fun = sum),
               # alpha=tf_idf,
               text = paste("<b>",term,"</b>",
                            # "<br>period: ",
                            # period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""))) +
    geom_col(fill="aquamarine4") +
    facet_wrap(~period, scales = "free", ncol=2) +
    scale_x_reordered() +
    coord_flip() +
    guides(fill=FALSE, color = FALSE, line = FALSE) +
    labs(title = paste0("words that distinguished enviro speeches per ", yrs, "-yr period"),
         # subtitle = paste0("differential attention is calculated by tf-idf, using temporal period (", yrs, " yr) as the 'document'"),
         y = "count",
         x = "keyword") +
    theme_minimal() +
    theme(#aspect.ratio=8/11,
      plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),#,size=10),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      strip.text=element_text(family="IBM Plex Mono",color="#32127a",face="bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
  
  ggsave(paste0(description, "--", yrs, "yr.jpg"),
          w =9.5, h=11, units = "in") #h=11,
  } 
 


##### make interactive
if (yrs==20) {
  
  ggplotly(enviro_distinguished_words_facet, tooltip="text", dynamicTicks = FALSE) %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  saveWidget(paste0(description,"--",yrs,"yr.html"),selfcontained = F)
  
}

    
  # # make interactive
  # ggplotly(enviro_distinguished_words_stacked, 
  #          tooltip="text", dynamicTicks = FALSE) %>%
  #          # mode='lines+markers+text') %>%
  # style(#mode="lines+markers",
  #       hoverlabel=list(font=list(family="IBM Plex Mono",
  #                                 size=11))) %>%
  # layout(font=list(color="#32127a",family="IBM Plex Mono"),
  #        xaxis=list(color="#32127a",
  #                   linecolor="#32127a",
  #                   tickfont=list(color="#32127a")),
  #        yaxis=list(color="#32127a",
  #                   linecolor="#32127a",
  #                   tickfont=list(color="#32127a"))) %>%
  # saveWidget(paste0(description, "_stacked--", yrs, "yr.html"),selfcontained = F)
  #   
}

```

```{r labor tf-ipf}

# ARCHITECTURE:
# a count of words per debate per speechdate is set up.
# tf-idf is calculated based on relative co-occurrence.

# the code cycles through big periods of years (5, 10, 20)
# and attempts to show the difference between tf-idf measures and raw count

# a second loop looks at smaller time periods (words relatively unique to a month, day ,etc.)

##### ENVIRO-labor #####
description <- "figures/laborBigrams-tfidf"
laborBigrams_60 <- laborBigrams %>%
  filter(year>="1960")
years <- as.tibble(unique(laborBigrams_60$year))
firstyear <- min(years$value)
lastyear <- max(years$value)
numyears <- nrow(years)

laborBigrams_count <- laborBigrams_60 %>%
  group_by(year,term) %>%
  count(term,wt=count) %>%
  filter(n>3)

# cycles through term counts by month, 6 month, year, etc.  
for (yrs in c(2, 5, 10, 20)) {
  
  ### count tfidf with n years as "document"
  print(paste0("counting tfidf by a ", yrs, "-year period"))
  labor_oneRowPerDocument <- laborBigrams_count %>%
    mutate(period = as.numeric(year) - as.numeric(year) %% yrs) %>%
    group_by(period, term) %>%
    dplyr::summarize(count = sum(n)) %>%
    ungroup() %>%
    mutate(id_number = period) %>%
    filter(!is.na(period)) %>%
    filter(!is.na(term)) %>%
    filter(!is.na(id_number))
  
  labor_tfidf <- labor_oneRowPerDocument %>%
    bind_tf_idf(term, id_number, count) %>%
    arrange(desc(tf_idf))
  
  labor_top_debates <- labor_tfidf %>%
    arrange(desc(tf_idf)) %>%
    slice(seq_len(25)) 
  
  # top_n_debates <- top_debates %>%
  #   slice(seq_len(10))
  
  labor_distinguished_words_stacked <- labor_top_debates %>%
    ggplot(aes(x = period,
               y = count,#tf_idf,
               text = paste("<b>",term,"</b>",
                            "<br>period: ",
                            period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""),
               label = term)) +
    geom_col(fill="blueviolet",aes(alpha=tf_idf)) +
    guides(fill=FALSE) + #alpha=FALSE
    geom_label_repel(
      color = "#32127a",
      fill="white",
      size=3.5,
      label.padding=unit(0.1,"lines"),
      alpha=0.75,
      family="IBM Plex Mono",
      fontface = "bold",
      force = 2,
      label.size = 0.1,
      position = position_stack(vjust = 0.5)) +
    labs(title = paste0("top 25 distinguishing words in labor speeches per ", yrs, "-yr period")) +
    theme_minimal() +
    theme(plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      legend.title=element_text(family="IBM Plex Mono",color="#32127a"),
      legend.text=element_text(family="IBM Plex Mono",color="#32127a"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
    
  ggsave(paste0(description, "_stacked--", yrs, "yr.jpg"),
         w=9.5,h=11,units = "in") #h=11,
  
  # bar chart of top tf-idf words per period
  labor_top_debates_per_unit <- labor_tfidf %>%
    group_by(period) %>%
    arrange(desc(tf_idf)) %>%
    slice(seq_len(10)) %>%
    ungroup() 
  
  if (yrs==2) {
      labor_distinguished_words_facet <- ggplot(labor_top_debates_per_unit,
           aes(y = count,
               x = reorder_within(term, 
                                  count, 
                                  period, 
                                  fun = sum),
               # alpha=tf_idf,
               text = paste("<b>",term,"</b>",
                            # "<br>period: ",
                            # period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""))) +
    geom_col(fill="blueviolet") +
    facet_wrap(~period, scales = "free", ncol=2) +
    scale_x_reordered() +
    coord_flip() +
    guides(fill=FALSE, color = FALSE, line = FALSE) +
    labs(title = paste0("words that distinguished labor speeches per ", yrs, "-yr period"),
         # subtitle = paste0("differential attention is calculated by tf-idf, using temporal period (", yrs, " yr) as the 'document'"),
         y = "count",
         x = "keyword") +
    theme_minimal() +
    theme(#aspect.ratio=8/11,
      plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),#,size=10),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      strip.text=element_text(family="IBM Plex Mono",color="#32127a",face="bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
  
  ggsave(paste0(description, "--", yrs, "yr.jpg"),
          w =9.5, h=24, units = "in") #h=11,
  }
  
  else {
  labor_distinguished_words_facet <- ggplot(labor_top_debates_per_unit,
           aes(y = count,
               x = reorder_within(term, 
                                  count, 
                                  period, 
                                  fun = sum),
               # alpha=tf_idf,
               text = paste("<b>",term,"</b>",
                            # "<br>period: ",
                            # period,
                            "<br>count: ",
                            count,
                            "<br>tf_idf: ",
                            signif(tf_idf,2),
                            sep=""))) +
    geom_col(fill="blueviolet") +
    facet_wrap(~period, scales = "free", ncol=2) +
    scale_x_reordered() +
    coord_flip() +
    guides(fill=FALSE, color = FALSE, line = FALSE) +
    labs(title = paste0("words that distinguished labor speeches per ", yrs, "-yr period"),
         # subtitle = paste0("differential attention is calculated by tf-idf, using temporal period (", yrs, " yr) as the 'document'"),
         y = "count",
         x = "keyword") +
    theme_minimal() +
    theme(#aspect.ratio=8/11,
      plot.title=element_text(family="IBM Plex Mono",color="#32127a",hjust=0.5,size=12,face="bold"),
      axis.title=element_text(family="IBM Plex Mono",color="#32127a"),
      axis.text=element_text(family="IBM Plex Mono",color="#32127a"),#,size=10),
      axis.line=element_line(color="#32127a"),
      axis.ticks=element_line(color="#32127a"),
      strip.text=element_text(family="IBM Plex Mono",color="#32127a",face="bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
  
  ggsave(paste0(description, "--", yrs, "yr.jpg"),
          w =9.5, h=11, units = "in") #h=11,
  } 
 


##### make interactive
if (yrs==20) {
  
  ggplotly(labor_distinguished_words_facet, tooltip="text", dynamicTicks = FALSE) %>%
  style(hoverlabel=list(font=list(family="IBM Plex Mono",
                                  size=11))) %>%
  layout(font=list(color="#32127a",family="IBM Plex Mono"),
         xaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a")),
         yaxis=list(color="#32127a",
                    linecolor="#32127a",
                    tickfont=list(color="#32127a"))) %>%
  saveWidget(paste0(description,"--",yrs,"yr.html"),selfcontained = F)
  
}

    
  # # make interactive
  # ggplotly(labor_distinguished_words_stacked, 
  #          tooltip="text", dynamicTicks = FALSE) %>%
  #          # mode='lines+markers+text') %>%
  # style(#mode="lines+markers",
  #       hoverlabel=list(font=list(family="IBM Plex Mono",
  #                                 size=11))) %>%
  # layout(font=list(color="#32127a",family="IBM Plex Mono"),
  #        xaxis=list(color="#32127a",
  #                   linecolor="#32127a",
  #                   tickfont=list(color="#32127a")),
  #        yaxis=list(color="#32127a",
  #                   linecolor="#32127a",
  #                   tickfont=list(color="#32127a"))) %>%
  # saveWidget(paste0(description, "_stacked--", yrs, "yr.html"),selfcontained = F)
  #   
}

```

#### triples
```{r extract triples, echo=FALSE}

Sys.time()
tic()
enviroSentences <- enviroLaborSpeeches %>%
  filter(environment=="Yes") %>%
  unnest_sentences(output=sentence,
                   input=speech,
                   strip_punct=TRUE,
                   format="text",
                   to_lower=TRUE,
                   drop=TRUE)
toc()

# enviroLaborSentences <- enviroLaborSpeeches %>%
#   filter(environment=="Yes") %>%
#   corpus(docid_field="year",
#          text_field="speech") %>%
#   tokenize_word_stems(stopwords=stopwords) %>%
#   tokenize_sentences(lowercase=TRUE,
#                      stopwords=stopwords,
#                      strip_punct=TRUE,
#                      strip_numeric=TRUE) %>%
#   tokens(remove_punct=TRUE,
#          split_tags=TRUE,
#          split_elisions=TRUE,
#          remove_symbols=TRUE,
#          remove_numbers=TRUE,
#          remove_separators=TRUE,
#          padding=FALSE,
#          verbose=TRUE,
#          xptr=TRUE)

enviroTriples <- enviroLaborSpeeches %>%
  filter(year>="1960") %>%
  filter(environment=="Yes") %>%
  sample_n(20) %>%
  extract_triples(col=speech)
enviroTriples_count <- enviroTriples %>%
  count(triple) %>%
  arrange(desc(n)) %>%

extract_adj_noun_pairs()
extract_subj_verb_pairs()

```


